{{ define "main" }}
  {{ $dateMachine := .Date | time.Format "2006-01-02T15:04:05-07:00" }}
  {{ $dateHuman := .Date | time.Format ":date_long" }}
  <time class="subtitle" datetime="{{ $dateMachine }}">{{ $dateHuman }}</time>
  <h1>{{ .Title }}</h1>

  {{ $content := .Content }}
  {{ $footnotes := index (findRE `(?s)<div class="footnotes".*?</div>` $content) 0 }}
  {{ range findRE `(?s)<li id="fn:[^"]*">.*?</li>` $footnotes }}
    {{ $id := replaceRE `id="fn:([^"]+)"` `${1}` (index (findRE `id="fn:[^"]*"` .) 0) }}
    {{ $footnote := replaceRE `(?s)^<li[^>]*>(.*?)</li>$` `${1}` . }}
    {{ $footnote := replaceRE `(?s)<p>(.*?)</p>` `${1}` $footnote }}
    {{ $footnote = replaceRE `<a href="#fnref:[^"]*"[^>]*>.*?</a>` `` $footnote }}
    {{ $sidenote := printf `<span class="sidenote"><sup>%s</sup>%s</span>` $id $footnote }}
    {{ $pattern := printf `(?s)(<sup id=".*"><a href="#fn:%s".*?</a></sup>)` $id }}
    {{ $replacement := printf `<sup>%s</sup>%s` $id $sidenote }}
    {{ $content = replaceRE $pattern $replacement $content }}
  {{ end }}
  {{ replace $content $footnotes "" | safeHTML }}

  <sig>&mdash;{{ index .Params.Author 0 }}</sig>
  {{ with site.Menus.main }}
    <nav>
      <ul>
        {{ range . }}
          <li><a href="{{ .URL }}">{{ .Name }}</a></li>
        {{ end }}
      </ul>
    </nav>
  {{ end }}
{{ end }}
